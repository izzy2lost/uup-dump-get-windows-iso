name: Build Windows 11 Bypass ISO

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Enable script execution
        shell: powershell
        run: Set-ExecutionPolicy Bypass -Scope Process -Force

      - name: Clone UUP Dump API
        run: git clone https://github.com/uup-dump/api uup

      - name: Prepare Windows 11 Home + Pro UUP Download
        shell: powershell
        run: |
          cd uup
          # This ID is for Windows 11 24H2 (26100.712) en-us x64
          Invoke-WebRequest `
            -Uri "https://uupdump.net/fetchupd.php?id=d3e090ef-98f1-43a7-8d5e-76f449c1ee02&lang=en-us&edition=professional,home&arch=x64&autodl=1" `
            -OutFile "uup.zip"
          Expand-Archive -Path "uup.zip" -DestinationPath "." -Force

      - name: Build Windows 11 ISO
        shell: powershell
        run: |
          cd uup
          .\uup_download_windows.ps1

      - name: Clone TPM Bypass Tool
        run: git clone https://github.com/JosephM101/Force-Windows-11-Install.git

      - name: Apply TPM/SecureBoot Bypass Patch
        shell: powershell
        run: |
          cd Force-Windows-11-Install
          $iso = Get-ChildItem "$Env:GITHUB_WORKSPACE" -Filter *.iso | Select-Object -First 1
          .\Win11-TPM-RegBypass.ps1 `
            -Source $iso.FullName `
            -Destination "$Env:GITHUB_WORKSPACE\\windows-11-bypass.iso"

      - name: Upload Bypass ISO Artifact
        uses: actions/upload-artifact@v4
        with:
          name: win11-bypass-iso
          path: windows-11-bypass.iso
